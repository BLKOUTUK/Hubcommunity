{% extends "base.html" %}

{% block title %}{{ event.name }} - BLKOUTHUB{% endblock %}

{% block page_title %}Event Details{% endblock %}

{% block content %}
<div class="row">
    <!-- Event Details -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-calendar-alt me-2"></i> Event Information
            </div>
            <div class="card-body">
                <h4 class="card-title">{{ event.name }}</h4>
                <p class="card-text">{{ event.description }}</p>
                
                <div class="mb-3">
                    <strong>Date:</strong> {{ event.event_date.split('T')[0] }}
                </div>
                <div class="mb-3">
                    <strong>Time:</strong> {{ event.event_date.split('T')[1][:5] }}
                </div>
                <div class="mb-3">
                    <strong>Location:</strong> {{ event.location }}
                </div>
                <div class="mb-3">
                    <strong>Type:</strong> {{ event.event_type }}
                </div>
                <div class="mb-3">
                    <strong>Max Attendees:</strong> {{ event.max_attendees if event.max_attendees else 'Unlimited' }}
                </div>
                {% if event.registration_url %}
                <div class="mb-3">
                    <strong>Registration URL:</strong> <a href="{{ event.registration_url }}" target="_blank">{{ event.registration_url }}</a>
                </div>
                {% endif %}
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="generateQRBtn" data-event-id="{{ event.id }}">
                        <i class="fas fa-qrcode"></i> Generate QR Code
                    </button>
                    <button class="btn btn-success" id="recordAttendanceBtn" data-event-id="{{ event.id }}">
                        <i class="fas fa-user-check"></i> Record Attendance
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Attendees -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-users me-2"></i> Attendees
            </div>
            <div class="card-body">
                {% if attendees %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Member Type</th>
                                <th>Check-in Time</th>
                                <th>Check-in Method</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attendee in attendees %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('member_detail', member_id=attendee.member_id) }}">
                                        {{ attendee.name }}
                                    </a>
                                </td>
                                <td>{{ attendee.email }}</td>
                                <td>{{ attendee.member_type }}</td>
                                <td>{{ attendee.check_in_time.split('T')[0] if attendee.check_in_time else 'Unknown' }}</td>
                                <td>{{ attendee.check_in_method }}</td>
                                <td>{{ attendee.notes }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center">No attendees found</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrCodeModalLabel">Event Check-in QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrCodeContainer">
                    <p>Loading QR code...</p>
                </div>
                <div id="checkInUrlContainer" class="mt-3">
                    <p>Check-in URL: <span id="checkInUrl"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Record Attendance Modal -->
<div class="modal fade" id="recordAttendanceModal" tabindex="-1" aria-labelledby="recordAttendanceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recordAttendanceModalLabel">Record Attendance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="recordAttendanceForm">
                    <input type="hidden" id="eventId" name="eventId">
                    <div class="mb-3">
                        <label for="memberId" class="form-label">Member</label>
                        <select class="form-select" id="memberId" name="memberId" required>
                            <option value="">Select a member</option>
                            <!-- Member options will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="checkInMethod" class="form-label">Check-in Method</label>
                        <select class="form-select" id="checkInMethod" name="checkInMethod">
                            <option value="manual">Manual</option>
                            <option value="qr_code">QR Code</option>
                            <option value="app">Mobile App</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="recordAttendanceSubmitBtn">Record Attendance</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Generate QR Code
        $("#generateQRBtn").click(function() {
            var eventId = $(this).data("event-id");
            
            $.ajax({
                url: "/api/events/" + eventId + "/qr-code",
                type: "GET",
                success: function(response) {
                    if (response.success) {
                        var checkInUrl = response.check_in_url;
                        
                        // Display the QR code (in a real implementation, this would be an actual QR code image)
                        $("#qrCodeContainer").html("<div style='width: 200px; height: 200px; background-color: #f5f5f5; border: 1px solid #ddd; margin: 0 auto; display: flex; align-items: center; justify-content: center;'>QR Code for " + checkInUrl + "</div>");
                        
                        // Display the check-in URL
                        $("#checkInUrl").text(checkInUrl);
                        
                        // Show the modal
                        $("#qrCodeModal").modal("show");
                    } else {
                        alert("Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error: " + error);
                }
            });
        });
        
        // Record Attendance
        $("#recordAttendanceBtn").click(function() {
            var eventId = $(this).data("event-id");
            
            // Set the event ID
            $("#eventId").val(eventId);
            
            // Load members
            $.ajax({
                url: "/api/members",
                type: "GET",
                success: function(response) {
                    if (response.success) {
                        var members = response.members;
                        var options = '<option value="">Select a member</option>';
                        
                        for (var i = 0; i < members.length; i++) {
                            options += '<option value="' + members[i].id + '">' + members[i].name + ' (' + members[i].email + ')</option>';
                        }
                        
                        $("#memberId").html(options);
                        
                        // Show the modal
                        $("#recordAttendanceModal").modal("show");
                    } else {
                        alert("Error loading members: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error loading members: " + error);
                }
            });
        });
        
        // Record Attendance Submit
        $("#recordAttendanceSubmitBtn").click(function() {
            var eventId = $("#eventId").val();
            var memberId = $("#memberId").val();
            var checkInMethod = $("#checkInMethod").val();
            var notes = $("#notes").val();
            
            if (!memberId) {
                alert("Please select a member");
                return;
            }
            
            // Prepare data
            var data = {
                member_id: memberId,
                check_in_method: checkInMethod,
                notes: notes
            };
            
            // Send request
            $.ajax({
                url: "/api/events/" + eventId + "/record-attendance",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        alert("Attendance recorded successfully!");
                        $("#recordAttendanceModal").modal("hide");
                        location.reload();
                    } else {
                        alert("Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error: " + error);
                }
            });
        });
    });
</script>
{% endblock %}
