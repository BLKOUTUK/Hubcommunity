{% extends "base.html" %}

{% block title %}Notifications - BLKOUTHUB{% endblock %}

{% block page_title %}Notifications{% endblock %}

{% block content %}
<div class="row">
    <!-- Notifications -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-bell me-2"></i> All Notifications
                </div>
                <div class="d-flex">
                    <input type="text" id="notificationSearch" class="form-control form-control-sm me-2" placeholder="Search notifications...">
                    <button class="btn btn-sm btn-danger" id="cleanupNotificationsBtn">
                        <i class="fas fa-trash"></i> Cleanup Old
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="notificationsTable">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Member</th>
                                <th>Title</th>
                                <th>Message</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for notification in notifications %}
                            <tr>
                                <td>
                                    {% if notification.type == 'achievement' %}
                                    <span class="badge badge-achievement">Achievement</span>
                                    {% elif notification.type == 'level_up' %}
                                    <span class="badge badge-level">Level Up</span>
                                    {% elif notification.type == 'challenge_completion' %}
                                    <span class="badge badge-points">Challenge</span>
                                    {% elif notification.type == 'access_level_change' %}
                                    <span class="badge badge-event">Access Level</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ notification.type }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('member_detail', member_id=notification.member_id) }}">
                                        {{ notification.member_name }}
                                    </a>
                                </td>
                                <td>{{ notification.title }}</td>
                                <td>{{ notification.message }}</td>
                                <td>{{ notification.created_at.split('T')[0] }}</td>
                                <td>
                                    {% if notification.read %}
                                    <span class="badge bg-success">Read</span>
                                    {% else %}
                                    <span class="badge bg-warning">Unread</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not notification.read %}
                                    <button class="btn btn-sm btn-primary mark-read-btn" data-notification-id="{{ notification.id }}">
                                        <i class="fas fa-check"></i> Mark Read
                                    </button>
                                    {% else %}
                                    <button class="btn btn-sm btn-warning mark-unread-btn" data-notification-id="{{ notification.id }}">
                                        <i class="fas fa-undo"></i> Mark Unread
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-danger delete-notification-btn" data-notification-id="{{ notification.id }}">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center">No notifications found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Webhooks -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-plug me-2"></i> Webhooks
                </div>
                <div>
                    <button class="btn btn-sm btn-primary" id="addWebhookBtn">
                        <i class="fas fa-plus"></i> Add Webhook
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>URL</th>
                                <th>Events</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for webhook in webhooks %}
                            <tr>
                                <td>{{ webhook.name }}</td>
                                <td>{{ webhook.url }}</td>
                                <td>
                                    {% for event in webhook.events %}
                                    <span class="badge bg-info">{{ event }}</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    {% if webhook.enabled %}
                                    <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Disabled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary test-webhook-btn" data-webhook-id="{{ webhook.id }}">
                                        <i class="fas fa-vial"></i> Test
                                    </button>
                                    <button class="btn btn-sm btn-warning edit-webhook-btn" data-webhook-id="{{ webhook.id }}" data-webhook-name="{{ webhook.name }}" data-webhook-url="{{ webhook.url }}" data-webhook-events="{{ webhook.events|join(',') }}" data-webhook-enabled="{{ webhook.enabled }}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-webhook-btn" data-webhook-id="{{ webhook.id }}">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center">No webhooks found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cleanup Notifications Modal -->
<div class="modal fade" id="cleanupNotificationsModal" tabindex="-1" aria-labelledby="cleanupNotificationsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cleanupNotificationsModalLabel">Cleanup Old Notifications</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>This will delete notifications older than the specified number of days.</p>
                <div class="mb-3">
                    <label for="cleanupDays" class="form-label">Days to keep</label>
                    <input type="number" class="form-control" id="cleanupDays" value="30" min="1" max="365">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="cleanupNotificationsConfirmBtn">Cleanup</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Webhook Modal -->
<div class="modal fade" id="webhookModal" tabindex="-1" aria-labelledby="webhookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="webhookModalLabel">Add Webhook</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="webhookForm">
                    <input type="hidden" id="webhookId" name="webhookId">
                    <div class="mb-3">
                        <label for="webhookName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="webhookName" name="webhookName" required>
                    </div>
                    <div class="mb-3">
                        <label for="webhookUrl" class="form-label">URL</label>
                        <input type="url" class="form-control" id="webhookUrl" name="webhookUrl" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Events</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="achievement" id="eventAchievement" name="webhookEvents">
                            <label class="form-check-label" for="eventAchievement">
                                Achievement
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="level_up" id="eventLevelUp" name="webhookEvents">
                            <label class="form-check-label" for="eventLevelUp">
                                Level Up
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="challenge_completion" id="eventChallenge" name="webhookEvents">
                            <label class="form-check-label" for="eventChallenge">
                                Challenge Completion
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="access_level_change" id="eventAccessLevel" name="webhookEvents">
                            <label class="form-check-label" for="eventAccessLevel">
                                Access Level Change
                            </label>
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="webhookEnabled" name="webhookEnabled" checked>
                        <label class="form-check-label" for="webhookEnabled">Enabled</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveWebhookBtn">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Search functionality
        $("#notificationSearch").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#notificationsTable tbody tr").filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
        
        // Mark notification as read
        $(".mark-read-btn").click(function() {
            var notificationId = $(this).data("notification-id");
            
            $.ajax({
                url: "/api/notifications/" + notificationId + "/read",
                type: "POST",
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert("Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error: " + error);
                }
            });
        });
        
        // Mark notification as unread
        $(".mark-unread-btn").click(function() {
            var notificationId = $(this).data("notification-id");
            
            $.ajax({
                url: "/api/notifications/" + notificationId + "/unread",
                type: "POST",
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert("Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error: " + error);
                }
            });
        });
        
        // Delete notification
        $(".delete-notification-btn").click(function() {
            var notificationId = $(this).data("notification-id");
            
            if (confirm("Are you sure you want to delete this notification?")) {
                $.ajax({
                    url: "/api/notifications/" + notificationId,
                    type: "DELETE",
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert("Error: " + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Error: " + error);
                    }
                });
            }
        });
        
        // Cleanup notifications
        $("#cleanupNotificationsBtn").click(function() {
            $("#cleanupNotificationsModal").modal("show");
        });
        
        $("#cleanupNotificationsConfirmBtn").click(function() {
            var days = $("#cleanupDays").val();
            
            $.ajax({
                url: "/api/notifications/cleanup",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({days: parseInt(days)}),
                success: function(response) {
                    if (response.success) {
                        alert("Deleted " + response.deleted_count + " old notifications");
                        $("#cleanupNotificationsModal").modal("hide");
                        location.reload();
                    } else {
                        alert("Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error: " + error);
                }
            });
        });
        
        // Add webhook
        $("#addWebhookBtn").click(function() {
            // Reset the form
            $("#webhookForm")[0].reset();
            $("#webhookId").val("");
            $("#webhookModalLabel").text("Add Webhook");
            
            // Show the modal
            $("#webhookModal").modal("show");
        });
        
        // Edit webhook
        $(".edit-webhook-btn").click(function() {
            var webhookId = $(this).data("webhook-id");
            var webhookName = $(this).data("webhook-name");
            var webhookUrl = $(this).data("webhook-url");
            var webhookEvents = $(this).data("webhook-events").split(",");
            var webhookEnabled = $(this).data("webhook-enabled");
            
            // Set the form values
            $("#webhookId").val(webhookId);
            $("#webhookName").val(webhookName);
            $("#webhookUrl").val(webhookUrl);
            
            // Check the event checkboxes
            $("input[name='webhookEvents']").prop("checked", false);
            for (var i = 0; i < webhookEvents.length; i++) {
                $("input[name='webhookEvents'][value='" + webhookEvents[i] + "']").prop("checked", true);
            }
            
            // Set the enabled checkbox
            $("#webhookEnabled").prop("checked", webhookEnabled === "true");
            
            // Set the modal title
            $("#webhookModalLabel").text("Edit Webhook");
            
            // Show the modal
            $("#webhookModal").modal("show");
        });
        
        // Save webhook
        $("#saveWebhookBtn").click(function() {
            var webhookId = $("#webhookId").val();
            var webhookName = $("#webhookName").val();
            var webhookUrl = $("#webhookUrl").val();
            var webhookEnabled = $("#webhookEnabled").is(":checked");
            
            // Get the selected events
            var webhookEvents = [];
            $("input[name='webhookEvents']:checked").each(function() {
                webhookEvents.push($(this).val());
            });
            
            if (!webhookName) {
                alert("Please enter a name");
                return;
            }
            
            if (!webhookUrl) {
                alert("Please enter a URL");
                return;
            }
            
            if (webhookEvents.length === 0) {
                alert("Please select at least one event");
                return;
            }
            
            // Prepare data
            var data = {
                name: webhookName,
                url: webhookUrl,
                events: webhookEvents,
                enabled: webhookEnabled
            };
            
            // Send request
            if (webhookId) {
                // Update webhook
                $.ajax({
                    url: "/api/webhooks/" + webhookId,
                    type: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: function(response) {
                        if (response.success) {
                            alert("Webhook updated successfully");
                            $("#webhookModal").modal("hide");
                            location.reload();
                        } else {
                            alert("Error: " + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Error: " + error);
                    }
                });
            } else {
                // Add webhook
                $.ajax({
                    url: "/api/webhooks",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: function(response) {
                        if (response.success) {
                            alert("Webhook added successfully");
                            $("#webhookModal").modal("hide");
                            location.reload();
                        } else {
                            alert("Error: " + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Error: " + error);
                    }
                });
            }
        });
        
        // Test webhook
        $(".test-webhook-btn").click(function() {
            var webhookId = $(this).data("webhook-id");
            
            $.ajax({
                url: "/api/webhooks/" + webhookId + "/test",
                type: "POST",
                success: function(response) {
                    if (response.success) {
                        alert("Webhook test sent successfully");
                    } else {
                        alert("Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert("Error: " + error);
                }
            });
        });
        
        // Delete webhook
        $(".delete-webhook-btn").click(function() {
            var webhookId = $(this).data("webhook-id");
            
            if (confirm("Are you sure you want to delete this webhook?")) {
                $.ajax({
                    url: "/api/webhooks/" + webhookId,
                    type: "DELETE",
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert("Error: " + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Error: " + error);
                    }
                });
            }
        });
    });
</script>
{% endblock %}
